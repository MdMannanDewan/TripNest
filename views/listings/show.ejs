<% layout('./layouts/boilerplate') -%>
<script>
  const MapApiKey = "<%=process.env.MAPTILER_API_KEY%>";
  let coordinates = JSON.parse(
    "<%- JSON.stringify(listing.geometry.coordinates) %>"
  );
  console.log(Array.isArray(coordinates));
  if (!coordinates.length) coordinates = [89.91514764726162, 24.25074630463834];
  // console.log(coordinates);
</script>
<body>
  <div class="d-flex align-items-center flex-column">
    <h3 class="text-center"><strong><%=listing.title%></strong></h3>
    <div class="card show-card">
      <img
        src="<%=listing.image.url%>"
        class="card-img-top show-img"
        alt="listing image"
      />
      <div class="card-body">
        <p class="mt-2">
          <strong>Owned By:</strong> <em><%= listing.owner.username %></em>
        </p>
        <p class="card-text">
          <%=listing.description%>
          <br />Price: &#2547;<%=listing.price.toLocaleString("en-BD")%>
          <br /><%=listing.location%> <br /><%=listing.country%>
        </p>
      </div>
    </div>
  </div>
  <% if (currentUser && currentUser._id.equals(listing.owner._id)) { %>
  <div class="d-flex align-items-center justify-content-center gap-4 mb-3">
    <div>
      <a href="/listings/<%=listing._id%>/edit"
        ><div class="btn btn-dark px-3 edit-btn">Edit</div></a
      >
    </div>
    <form action="/listings/<%=listing._id%>?_method=DELETE" method="POST">
      <button class="btn btn-dark px-3 delete-btn">Delete</button>
    </form>
  </div>
  <hr />
  <% } %> <% if (currentUser) { %>
  <div class="d-flex align-items-center flex-column mb-3">
    <h4 class="mb-3">Leave a Review</h4>
    <form
      class="needs-validation"
      novalidate
      action="/listings/<%=listing._id%>/reviews"
      method="POST"
    >
      <div class="mb-3">
        <fieldset class="starability-slot">
          <legend>Rating:</legend>
          <input
            type="radio"
            id="no-rate"
            class="input-no-rate"
            name="review[rating]"
            value="1"
            checked
            aria-label="No rating."
          />
          <input
            type="radio"
            id="first-rate1"
            name="review[rating]"
            value="1"
          />
          <label for="first-rate1" title="Terrible">1 star</label>
          <input
            type="radio"
            id="first-rate2"
            name="review[rating]"
            value="2"
          />
          <label for="first-rate2" title="Not good">2 stars</label>
          <input
            type="radio"
            id="first-rate3"
            name="review[rating]"
            value="3"
          />
          <label for="first-rate3" title="Average">3 stars</label>
          <input
            type="radio"
            id="first-rate4"
            name="review[rating]"
            value="4"
          />
          <label for="first-rate4" title="Very good">4 stars</label>
          <input
            type="radio"
            id="first-rate5"
            name="review[rating]"
            value="5"
          />
          <label for="first-rate5" title="Amazing">5 stars</label>
        </fieldset>
      </div>
      <div class="mb-3">
        <label for="comment" class="form-label fw-bold"
          >Comment about our Service
        </label>
        <textarea
          id="comment"
          class="form-control"
          type="text"
          name="review[comment]"
          required
        ></textarea>
        <div class="invalid-feedback">please add a comment</div>
      </div>
      <button class="btn btn-outline-dark">Submit</button>
    </form>
  </div>
  <% } %>
  <hr />
  <% if (listing.reviews.length>0) { %>
  <div>
    <h4>All Reviews</h4>
    <div
      class="d-flex flex-wrap justify-content-center align-items-center gap-4"
    >
      <% for( let review of listing.reviews) { %>
      <div
        class="card my-3 shadow-sm border border-2 border-secondary px-5 py-3"
      >
        <div class="card-body">
          <!-- Author -->
          <h6 class="card-subtitle mb-1 text-primary">
            @<%= review.author.username %>
          </h6>

          <!-- Rating (just below username) -->
          <p
            class="starability-result mb-2 small"
            data-rating="<%= review.rating %>"
          ></p>

          <!-- Comment -->
          <p class="card-text"><%= review.comment %></p>

          <!-- Delete Button (only if owner) -->
          <% if (currentUser && currentUser._id.equals(review.author._id)) { %>
          <form
            action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE"
            method="POST"
            class="mt-2"
          >
            <button class="btn btn-sm btn-outline-danger">
              <i class="bi bi-trash"></i> Delete
            </button>
          </form>
          <% } %>
        </div>
      </div>

      <% } %>
    </div>
  </div>
  <% } %>
  <div
    class="d-flex flex-column align-items-center justify-content-center gap-4 mb-3"
  >
    <h4>Where you'll be</h4>
    <div id="map"></div>
    <script src="/js/map.js"></script>
  </div>
</body>
